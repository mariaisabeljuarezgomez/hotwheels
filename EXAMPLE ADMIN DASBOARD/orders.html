<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orders - Admin</title>
  <link rel="stylesheet" href="../css/main.css" />
</head>
<body class="bg-background text-text-primary">
  <main class="max-w-6xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="font-orbitron text-2xl font-bold">Orders</h1>
      <a href="admin.html" class="text-accent">Back to Dashboard</a>
    </div>

    <div class="glass-card rounded-xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2 flex-wrap">
          <input id="q" class="bg-surface border border-surface-light text-text-primary px-3 py-2 rounded text-sm" placeholder="Search order # or name" />
          <select id="status" class="bg-surface border border-surface-light text-text-primary px-3 py-2 rounded text-sm">
            <option value="">All statuses</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="completed">Completed</option>
          </select>
          <input type="date" id="date_from" class="bg-surface border border-surface-light text-text-primary px-3 py-2 rounded text-sm" />
          <input type="date" id="date_to" class="bg-surface border border-surface-light text-text-primary px-3 py-2 rounded text-sm" />
          <button id="applyFilters" class="btn-primary px-4 py-2 text-sm">Apply</button>
          <button id="refreshOrders" class="border border-accent text-accent px-4 py-2 rounded text-sm">Reset</button>
        </div>
        <div>
          <button id="exportOrdersLocal" class="border border-accent text-accent px-4 py-2 rounded text-sm">Export CSV</button>
        </div>
      </div>
      <div id="ordersLoading" class="text-center py-6 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
        <p class="text-text-secondary mt-2">Loading orders...</p>
      </div>
      <div id="ordersEmpty" class="text-center py-6 hidden text-text-secondary text-sm">No orders found</div>
      <div id="ordersList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </main>

  <!-- Order Detail Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-background rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="font-orbitron text-xl font-bold">Order Details</h2>
            <button id="closeModal" class="text-text-secondary hover:text-white text-2xl">&times;</button>
          </div>

          <div id="orderDetailContent">
            <!-- Order details will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function checkAuth() {
      const token = localStorage.getItem('adminToken');
      if (!token) { window.location.href = 'admin-login.html'; return null; }
      return token;
    }

    async function apiRequest(url, options = {}) {
      const token = checkAuth();
      if (!token) return null;
      const res = await fetch(url, { ...options, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...(options.headers||{}) } });
      if (res.status === 401) { localStorage.removeItem('adminToken'); localStorage.removeItem('adminUser'); window.location.href = 'admin-login.html'; return null; }
      return res;
    }

    function formatTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
      if (diffInHours < 1) return 'Just now';
      if (diffInHours < 24) return `${diffInHours}h ago`;
      if (diffInHours < 48) return '1d ago';
      return `${Math.floor(diffInHours / 24)}d ago`;
    }

    async function loadOrders() {
      const loading = document.getElementById('ordersLoading');
      const emptyEl = document.getElementById('ordersEmpty');
      const listEl = document.getElementById('ordersList');
      loading.classList.remove('hidden');
      emptyEl.classList.add('hidden');
      listEl.innerHTML = '';
      const params = new URLSearchParams();
      const q = document.getElementById('q').value.trim();
      const status = document.getElementById('status').value;
      const from = document.getElementById('date_from').value;
      const to = document.getElementById('date_to').value;
      params.set('limit','30');
      // Support deep link by orderId to focus order
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('orderId');
      if (orderId) params.set('q', orderId);
      if (q) params.set('q', q);
      if (status) params.set('status', status);
      if (from) params.set('date_from', from);
      if (to) params.set('date_to', to);
      const res = await apiRequest(`/api/orders?${params.toString()}`);
      if (!res) return;
      const data = await res.json();
      const orders = (data && data.orders) || [];
      if (orders.length === 0) { emptyEl.classList.remove('hidden'); loading.classList.add('hidden'); return; }
      listEl.innerHTML = orders.map(renderOrder).join('');
      loading.classList.add('hidden');
    }

    function renderOrder(order) {
      return `
        <div class="p-4 bg-surface-dark rounded-lg border border-surface-light cursor-pointer hover:border-accent transition-all duration-300" onclick="openOrderModal(${order.id})">
          <div class="flex items-center justify-between mb-2">
            <span class="text-white font-medium text-sm">${order.order_number}</span>
            <span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span>
          </div>
          <div class="text-text-secondary text-xs mb-2">${formatTimeAgo(order.created_at)}</div>
          <div class="flex items-center justify-between">
            <span class="text-accent font-bold text-sm">$${order.total_amount}</span>
            <span class="text-text-secondary text-xs">${order.customer_name || ''}</span>
          </div>
          <div class="text-xs text-accent mt-2 cursor-pointer">Click for details â†’</div>
        </div>
      `;
    }

    async function openOrderModal(orderId) {
      const token = localStorage.getItem('adminToken');
      if (!token) return (window.location.href = 'admin-login.html');

      try {
        const response = await fetch(`/api/orders/${orderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load order details');

        const data = await response.json();
        const { order, items } = data;

        renderOrderDetailModal(order, items);
        document.getElementById('orderModal').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading order details:', error);
        alert('Failed to load order details');
      }
    }

    function renderOrderDetailModal(order, items) {
      const content = document.getElementById('orderDetailContent');

      let html = `
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Order Info -->
          <div>
            <h3 class="font-orbitron text-lg font-semibold mb-4">Order Information</h3>
            <div class="space-y-2">
              <div><span class="text-text-secondary">Order #:</span> <span class="text-white">${order.order_number}</span></div>
              <div><span class="text-text-secondary">Status:</span> <span class="status-badge status-${order.status}">${order.status}</span></div>
              <div><span class="text-text-secondary">Date:</span> <span class="text-white">${new Date(order.created_at).toLocaleString()}</span></div>
              <div><span class="text-text-secondary">Customer:</span> <span class="text-white">${order.customer_name || 'N/A'}</span></div>
              <div><span class="text-text-secondary">Email:</span> <span class="text-white">${order.customer_email || 'N/A'}</span></div>
              <div><span class="text-text-secondary">Total:</span> <span class="text-accent font-bold">$${order.total_amount}</span></div>
            </div>
          </div>

          <!-- Shipping Info -->
          <div>
            <h3 class="font-orbitron text-lg font-semibold mb-4">Shipping Information</h3>
            <div class="space-y-2">
              <div><span class="text-text-secondary">Name:</span> <span class="text-white">${order.shipping_name || 'N/A'}</span></div>
              <div><span class="text-text-secondary">Address:</span> <span class="text-white">${order.shipping_address || 'N/A'}</span></div>
              <div><span class="text-text-secondary">City:</span> <span class="text-white">${order.shipping_city || 'N/A'}</span></div>
              <div><span class="text-text-secondary">State:</span> <span class="text-white">${order.shipping_state || 'N/A'}</span></div>
              <div><span class="text-text-secondary">ZIP:</span> <span class="text-white">${order.shipping_zip || 'N/A'}</span></div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="mt-6">
          <h3 class="font-orbitron text-lg font-semibold mb-4">Order Items</h3>
          <div class="space-y-4">
      `;

      items.forEach(item => {
        html += `
          <div class="bg-surface-dark rounded-lg p-4">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h4 class="font-semibold text-white">${item.product_name}</h4>
                <div class="text-text-secondary text-sm">
                  Size: ${item.size} | Color: ${item.color} | Quantity: ${item.quantity}
                </div>
                <div class="text-accent font-bold">$${item.price}</div>
              </div>
            </div>
        `;

        // Display custom input data including custom questions
        if (item.custom_input) {
          const customInput = typeof item.custom_input === 'string' ? JSON.parse(item.custom_input) : item.custom_input;

          html += `<div class="mt-3 p-3 bg-surface bg-opacity-20 rounded border border-surface-light">`;

          // Display standard custom inputs (birthday/lyrics fields)
          const standardFields = Object.keys(customInput).filter(key =>
            (key.includes('birthday_') || key.includes('lyrics_')) &&
            !key.includes('custom_question')
          );

          if (standardFields.length > 0) {
            html += `<h5 class="text-accent font-semibold mb-2">Standard Custom Inputs:</h5>`;
            standardFields.forEach(key => {
              const displayKey = key.replace('birthday_', '').replace('lyrics_', '').replace(/_/g, ' ');
              html += `<div class="text-sm"><span class="text-text-secondary">${displayKey}:</span> <span class="text-white">${customInput[key]}</span></div>`;
            });
          }

          // Display custom question responses
          const customQuestions = Object.keys(customInput).filter(key => key.includes('custom_question'));
          if (customQuestions.length > 0) {
            html += `<h5 class="text-warning font-semibold mb-2 mt-3">ðŸŽ¯ Custom Question Responses:</h5>`;
            customQuestions.forEach(key => {
              const questionType = key.includes('birthday') ? 'Birthday Question' : 'Lyrics Question';
              html += `
                <div class="bg-warning bg-opacity-10 p-3 rounded border border-warning border-opacity-30 mb-2">
                  <div class="text-warning font-medium mb-1">${questionType}:</div>
                  <div class="text-white">${customInput[key]}</div>
                </div>
              `;
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
      });

      html += `
          </div>
        </div>
      `;

      content.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!checkAuth()) return;
      loadOrders();
      document.getElementById('refreshOrders').addEventListener('click', () => { document.getElementById('q').value=''; document.getElementById('status').value=''; document.getElementById('date_from').value=''; document.getElementById('date_to').value=''; loadOrders(); });
      document.getElementById('applyFilters').addEventListener('click', loadOrders);
      document.getElementById('exportOrdersLocal').addEventListener('click', async () => {
        const token = localStorage.getItem('adminToken');
        if (!token) return (window.location.href = 'admin-login.html');
        const period = '7d';
        const res = await fetch(`/api/orders/export?period=${period}`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!res.ok) return alert('Export failed');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `orders_${period}.csv`; a.click(); URL.revokeObjectURL(url);
      });

      // Modal close functionality
      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('orderModal').classList.add('hidden');
      });

      // Close modal when clicking outside
      document.getElementById('orderModal').addEventListener('click', (e) => {
        if (e.target.id === 'orderModal') {
          document.getElementById('orderModal').classList.add('hidden');
        }
      });

      // Check for highlight parameter (when coming from admin dashboard)
      const urlParams = new URLSearchParams(window.location.search);
      const highlightOrder = urlParams.get('highlight');
      if (highlightOrder) {
        // Wait for orders to load, then find and open the highlighted order
        setTimeout(() => {
          // This will be handled by the loadOrders callback
        }, 1000);
      }
    });
  </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>


